name: Build-Surface-ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Clean Previous Builds
        run: |
          sudo umount -l chroot_dir/dev chroot_dir/proc chroot_dir/sys || true
          sudo rm -rf iso_extract chroot_dir base.iso Kubuntu-Surface-Ready.iso

      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y squashfs-tools xorriso wget mtools isolinux syslinux-common

      - name: Download Kubuntu
        run: |
          wget https://cdimage.ubuntu.com/kubuntu/releases/24.04/release/kubuntu-24.04.3-desktop-amd64.iso -O base.iso

      - name: Extract and Modify
        run: |
          mkdir -p iso_extract chroot_dir
          osirrox -indev base.iso -extract / iso_extract
          sudo unsquashfs -no-xattrs -d chroot_dir iso_extract/casper/filesystem.squashfs
          
          sudo mount --bind /dev chroot_dir/dev
          sudo mount --bind /proc chroot_dir/proc
          sudo mount --bind /sys chroot_dir/sys
          sudo cp /etc/resolv.conf chroot_dir/etc/resolv.conf
          
          sudo chroot chroot_dir /bin/bash <<EOF
          apt-get update
          apt-get install -y curl gnupg lsb-release
          curl -s https://raw.githubusercontent.com/linux-surface/linux-surface/master/pkg/keys/surface.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/linux-surface.gpg
          echo "deb [arch=amd64] https://pkg.surfacelinux.com/debian release main" | tee /etc/apt/sources.list.d/linux-surface.list
          apt-get update
          apt-get install --no-install-recommends -y linux-image-surface linux-headers-surface iptsd libwacom-surface surface-control
          apt-get autoremove -y
          apt-get clean
          EOF
          
          sudo umount -l chroot_dir/dev chroot_dir/proc chroot_dir/sys
          sudo rm chroot_dir/etc/resolv.conf

      - name: Rebuild ISO
        run: |
          sudo rm -f iso_extract/casper/filesystem.squashfs
          sudo mksquashfs chroot_dir iso_extract/casper/filesystem.squashfs -noappend -comp xz
          
          cd iso_extract
          sudo xorriso -as mkisofs \
            -r -V "Kubuntu-Surface" \
            -o ../Kubuntu-Surface-Ready.iso \
            -J -l -b boot/grub/i386-pc/eltorito_boot_catalog -c boot.catalog \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot \
            -isohybrid-mbr /usr/lib/syslinux/mbr/isohdpfx.bin .

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: Surface-ISO
          path: Kubuntu-Surface-Ready.iso
          retention-days: 1
