name: Build-Surface-ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Sudo Warmup
        run: sudo -v

      - name: Clean Previous Builds
        run: |
          sudo umount -l chroot_dir/dev chroot_dir/proc chroot_dir/sys || true
          sudo rm -rf iso_extract chroot_dir base.iso Kubuntu-Surface-Ready.iso

      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y squashfs-tools xorriso wget mtools isolinux syslinux-common

      - name: Download Kubuntu
        run: |
          wget https://cdimage.ubuntu.com/kubuntu/releases/24.04/release/kubuntu-24.04.3-desktop-amd64.iso -O base.iso

      - name: Extract and Modify
        run: |
          mkdir -p iso_extract chroot_dir
          osirrox -indev base.iso -extract / iso_extract
          sudo unsquashfs -no-xattrs -d chroot_dir iso_extract/casper/filesystem.squashfs
          
          sudo mount --bind /dev chroot_dir/dev
          sudo mount --bind /proc chroot_dir/proc
          sudo mount --bind /sys chroot_dir/sys
          sudo cp /etc/resolv.conf chroot_dir/etc/resolv.conf
          
          sudo chroot chroot_dir /bin/bash <<EOF
          apt-get update
          apt-get install -y curl gnupg lsb-release
          curl -s https://raw.githubusercontent.com/linux-surface/linux-surface/master/pkg/keys/surface.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/linux-surface.gpg
          echo "deb [arch=amd64] https://pkg.surfacelinux.com/debian release main" | tee /etc/apt/sources.list.d/linux-surface.list
          apt-get update
          apt-get install --no-install-recommends -y linux-image-surface linux-headers-surface iptsd libwacom-surface surface-control
          apt-get autoremove -y
          apt-get clean
          EOF
          
          sudo umount -l chroot_dir/dev chroot_dir/proc chroot_dir/sys
          sudo rm chroot_dir/etc/resolv.conf

      - name: Rebuild ISO
        run: |
          sudo rm -f iso_extract/casper/filesystem.squashfs
          sudo mksquashfs chroot_dir iso_extract/casper/filesystem.squashfs -noappend -comp gzip
          
          cd iso_extract
          # DYNAMICALLY FIND THE BOOT FILES
          # We search for the files and strip the './' prefix for xorriso
          BOOT_CAT=$(find . -name "boot.catalog" | sed 's|^\./||' | head -n 1)
          ELTORITO=$(find . -name "*eltorito*" | sed 's|^\./||' | head -n 1)
          EFI_IMG=$(find . -name "efi.img" | sed 's|^\./||' | head -n 1)
          MBR_BIN=$(find /usr/lib -name "isohdpfx.bin" | head -n 1)

          echo "Using Boot Catalog: $BOOT_CAT"
          echo "Using Eltorito: $ELTORITO"
          echo "Using EFI Image: $EFI_IMG"
          echo "Using MBR Bin: $MBR_BIN"

          sudo xorriso -as mkisofs \
            -r -V "Kubuntu-Surface" \
            -o ../Kubuntu-Surface-Ready.iso \
            -J -l \
            -isohybrid-mbr "$MBR_BIN" \
            -partition_offset 16 \
            -c "$BOOT_CAT" \
            -b "$ELTORITO" \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot \
            -e "$EFI_IMG" -no-emul-boot \
            .

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: Surface-ISO
          path: Kubuntu-Surface-Ready.iso
          retention-days: 1
